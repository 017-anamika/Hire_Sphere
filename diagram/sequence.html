<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hire Sphere - Final Sequence Diagram</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: #f4f7f9;
            color: #333;
            padding: 30px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        h1 {
            color: #2c3e50;
        }
        
        .diagram-container {
            width: 100%;
            max-width: 1400px;
            margin-top: 30px;
            padding: 20px;
            background-color: #fff;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            border-radius: 10px;
        }

        .participants {
            display: flex;
            justify-content: space-around;
            border-bottom: 2px solid #34495e;
            padding-bottom: 10px;
        }

        .participant {
            width: 180px;
            text-align: center;
            font-weight: bold;
            position: relative;
        }
        
        .participant .box {
            background-color: #3498db;
            color: white;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
        }
        .participant .worker { background-color: #9b59b6; }
        .participant .db { background-color: #16a085; }


        .lifeline {
            border-left: 2px dashed #bdc3c7;
            height: 600px; /* Increased height for more steps */
            margin: 0 auto;
        }
        
        .messages {
            position: relative;
            top: -600px; /* Match lifeline height */
            padding: 0 2%;
            height: 600px;
        }

        .message {
            position: absolute;
        }

        .message p {
            background-color: #ecf0f1;
            padding: 8px 12px;
            border-radius: 5px;
            font-size: 0.9em;
            position: absolute;
            white-space: nowrap;
            border: 1px solid #bdc3c7;
        }
        
        .message .arrow {
            position: absolute;
            width: 0;
            height: 0;
            border-top: 6px solid transparent;
            border-bottom: 6px solid transparent;
        }
        
        /* Message positioning and arrows */
        /* Request Path */
        .msg-1  { top: 30px; left: 12.5%; width: 25%; }
        .msg-2  { top: 90px; left: 37.5%; width: 25%; }
        .msg-3  { top: 150px; left: 62.5%; width: 25%; }
        
        /* Database Operations */
        .msg-4  { top: 210px; left: 37.5%; width: 25%; }
        .msg-5  { top: 270px; left: 37.5%; width: 25%; }

        /* Return Path */
        .msg-6  { top: 330px; left: 12.5%; width: 25%; }
        .msg-7  { top: 390px; left: -12.5%; width: 25%; }

        /* Async Path */
        .msg-8  { top: 450px; left: 37.5%; width: 50%; }
        .msg-9  { top: 510px; left: 62.5%; width: 25%; }
        
        /* Arrow Styles */
        .request-arrow .arrow { border-left: 10px solid #bdc3c7; }
        .response-arrow p { background-color: #e2f5ea; border-color: #27ae60; }
        .response-arrow .arrow { border-right: 10px solid #bdc3c7; transform: translateX(-10px); }
        .async-arrow p { border-style: dashed; }

        .message.request-arrow p { left: 0; }
        .message.request-arrow .arrow { left: 100%; top: 8px; }

        .message.response-arrow p { right: 0; text-align: right; }
        .message.response-arrow .arrow { right: 100%; top: 8px; }
        
        .rationale {
            max-width: 1000px;
            text-align: left;
        }

    </style>
</head>
<body>

    <h1>Final Sequence Diagram: User Applies for a Job</h1>

    <div class="diagram-container">
        <div class="participants">
            <div class="participant"><div class="box">User</div><div class="lifeline"></div></div>
            <div class="participant"><div class="box">React Client</div><div class="lifeline"></div></div>
            <div class="participant"><div class="box">Node.js API Server</div><div class="lifeline"></div></div>
            <div class="participant"><div class="box db">MongoDB</div><div class="lifeline"></div></div>
            <div class="participant"><div class="box worker">Worker Service</div><div class="lifeline"></div></div>
        </div>
        <div class="messages">
            <div class="message request-arrow msg-1"><p>1. Clicks 'Apply' on Job</p><div class="arrow"></div></div>
            <div class="message request-arrow msg-2"><p>2. POST /api/jobs/:id/apply</p><div class="arrow"></div></div>
            <div class="message request-arrow msg-3"><p>3. Validate User & Job</p><div class="arrow"></div></div>
            <div class="message request-arrow msg-4"><p>4. Create Application Doc</p><div class="arrow"></div></div>
            <div class="message request-arrow msg-5"><p>5. Create Notification Doc</p><div class="arrow"></div></div>
            <div class="message response-arrow msg-6"><p>6. Return { success: true }</p><div class="arrow"></div></div>
            <div class="message response-arrow msg-7"><p>7. Display "Application Sent!"</p><div class="arrow"></div></div>
            <div class="message request-arrow async-arrow msg-8"><p>8. [Async] Push Job to Queue (SendNotif)</p><div class="arrow"></div></div>
            <div class="message request-arrow async-arrow msg-9"><p>9. Send Email to Recruiter</p><div class="arrow"></div></div>
        </div>
    </div>
    
    <div class="rationale">
        <h2>Diagram Rationale & Flow Explanation</h2>
        <p>This sequence diagram details the robust process for a core feature: a user applying for a job. It ensures the system is responsive, reliable, and provides good user feedback.</p>
        <ol>
            <li><strong>User Action:</strong> The user finds a job and clicks the "Apply" button in the React UI.</li>
            <li><strong>API Request:</strong> The React client sends an authenticated `POST` request to the API server for the specific job.</li>
            <li><strong>Validation:</strong> The API server receives the request and performs critical validation: Is this a valid user? Does the job they are applying for still exist?</li>
            <li><strong>Create Application:</strong> The server creates a new document in the `applications` collection in MongoDB, linking the user's ID with the job's ID.</li>
            <li><strong>Create In-App Notification:</strong> The server also creates a document in the `notifications` collection so the recruiter can see the new applicant inside the app.</li>
            <li><strong>Immediate Feedback:</strong> The server immediately sends a success response back to the React client. This is crucial for a good user experience.</li>
            <li><strong>UI Update:</strong> The React client receives the success response and updates the UI instantly, for example, by showing a "âœ“ Application Sent!" message. The user is not left waiting.</li>
            <li><strong>Asynchronous Work:</strong> After sending the success response, the server pushes a job to a background queue (managed by Redis/BullMQ). The job contains information needed to send an email.</li>
            <li><strong>Email Notification:</strong> A separate **Worker Service**, which is always listening to the queue, picks up the job and handles the process of sending an email to the recruiter. This slow operation happens entirely in the background, without affecting the performance of the main API server or the user's experience.</li>
        </ol>
    </div>

</body>
</html>